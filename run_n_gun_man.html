<!DOCTYPE html>
<html>
<body>
	<canvas id="canvas" width="500" height="500" style="background-color: rgb(750, 750, 750); border: 3px solid black;">
		Your browser does not support the HTML5 canvas tag
	</canvas>
	<script src='collision.js'></script>
	<script>

		canvas.focus();
		var c = canvas.getContext("2d");
		var keys = new Object();

		document.onkeydown = function(e){
			keys[e.keyCode] = true;
		}

		document.onkeyup = function(e){
			delete keys[e.keyCode];
		}

		var KEY_ENTER = 13;
		var KEY_UP = 38;
		var KEY_DOWN = 40;
		var KEY_LEFT = 37;
		var KEY_RIGHT = 39;

		var acceleration = 0.001;
		var restitution = 0.8;
		var friction = 0.999;
		var surfaceFriction = 0.9;
		var gravity = 0.0005;
		function setup(){
			oldTime = performance.now();
			boxA = box(10, 10, 10, 20);
			boxB = box(100, 200, 300, 100);
			xSpeed = 0.0;
			ySpeed = 0.0;
		} setup();

		function update(time){
			var timeStep = time - oldTime;
			oldTime = time;

			if(keys[KEY_ENTER])
				setup();

			controls(timeStep);
			physics(timeStep);
		}

		function controls(timeStep){
			if(keys[KEY_UP])
				ySpeed -= acceleration * timeStep;
			if(keys[KEY_DOWN])
				ySpeed += acceleration * timeStep;
			if(keys[KEY_LEFT])
				xSpeed -= acceleration * timeStep;
			if(keys[KEY_RIGHT])
				xSpeed += acceleration * timeStep;
		}

		function physics(timeStep){
			var impact = impactData(boxA, boxB, xSpeed, ySpeed);
			var remainingTime = timeStep;

			if(impact.time <= timeStep && impact.time >= 0){
				console.log(impact.side);

				move(impact.time);
				bounce(impact.side);
				remainingTime -= impact.time;
			}

			move(remainingTime);

			if(boxA.x < 0 || boxA.x > canvas.width - boxA.width){
				bounce('left');
				boxA.x = clamp(0, canvas.width - boxA.width, boxA.x);
			}
			if(boxA.y < 0 || boxA.y > canvas.height - boxA.height){
				bounce('up');
				boxA.y = clamp(0, canvas.height - boxA.height, boxA.y);
			}

			xSpeed *= Math.pow(friction, timeStep); //Friction
			ySpeed *= Math.pow(friction, timeStep);

			ySpeed += gravity * timeStep;
		}

		function move(timeStep){
			boxA.x += timeStep * xSpeed;
			boxA.y += timeStep * ySpeed;
		}

		function bounce(side){
			if(side == 'left' || side == 'right'){
				xSpeed *= -restitution;
				ySpeed *= surfaceFriction;
			}
			else{
				ySpeed *= -restitution;
				xSpeed *= surfaceFriction;
			}
		}

		function render(){
			c.clearRect(0, 0, canvas.width, canvas.height);
			var draw = function(aBox, color){
				c.fillStyle = color;
				c.fillRect(aBox.x, aBox.y, aBox.width, aBox.height)
			};
			draw(boxB, 'blue');
			draw(boxA, 'red');
		}

		function reload(time){
			update(time);
			render();
			requestAnimationFrame(reload);
		}	reload(performance.now());
		
	</script>
</body>
</html>